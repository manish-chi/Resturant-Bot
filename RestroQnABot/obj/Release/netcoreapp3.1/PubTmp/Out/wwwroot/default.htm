<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>WebChat</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        html,
        body {
            height: 100%;
            width: 100%;
            margin: 0;
        }

        #webchat {
            height: 100%;
            width: 40%;
        }

            #webchat > * {
                height: 100%;
                width: 100%;
            }
    </style>
</head>

<body>
<div id="webchat" role="main"></div>
<script type="text/javascript"
        src="https://unpkg.com/markdown-it/dist/markdown-it.min.js"></script>
<script src="https://cdn.botframework.com/botframework-webchat/master/webchat.js"></script>
<script>
    (async function () {
        let { token, conversationId } = sessionStorage;

        if (!token) {
            const res = await fetch('https://directline.botframework.com/v3/directline/tokens/generate', { method: 'POST', headers: { 'Authorization': 'Bearer  6-VElXBA6ww.kN-OI_J03pClrpS8XjLgAc9nuKiXASomR20z1AMcaPc' } });
            const { token: directLineToken } = await res.json();

            sessionStorage['token'] = directLineToken;
            token = directLineToken;
        }

        if (conversationId) {
            const res = await fetch(`https://directline.botframework.com/v3/directline/conversations/${conversationId}`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                },
            });

            let { conversationId } = await res.json();
            sessionStorage['conversationId'] = conversationId;
        }

        const store = window.WebChat.createStore({}, ({ dispatch }) => next => action => {
            if (action.type === 'DIRECT_LINE/CONNECT_FULFILLED') {
                // When we receive DIRECT_LINE/CONNECT_FULFILLED action, we will send an event activity using WEB_CHAT/SEND_EVENT
                dispatch({
                    type: 'WEB_CHAT/SEND_EVENT',
                    payload: {
                        name: 'webchat/join',
                        value: { language: window.navigator.language }
                    }
                });
            }
            return next(action);
        });


        window.WebChat.renderWebChat(
            {
                directLine: window.WebChat.createDirectLine({
                    token: token
                }),
                userID: 'YOUR_USER_ID',
                username: 'Web Chat User',
                locale: 'en-US',
                botAvatarInitials: 'WC',
                userAvatarInitials: 'WW',
                store
            },
            document.getElementById('webchat')
        );


    })().catch(err => console.error(err));
</script>
</body>
</html>